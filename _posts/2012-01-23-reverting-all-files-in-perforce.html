---
layout: post
status: publish
published: true
title: Reverting All Files In Perforce
author:
  display_name: Rob Petti
  login: rpetti
  email: rob.petti@gmail.com
  url: http://www.robpetti.com
author_login: rpetti
author_email: rob.petti@gmail.com
author_url: http://www.robpetti.com
excerpt: "I often find myself in the situation where I need to delete the perforce
  account of a user who has left the company. Unfortunately I'm usually unable to
  do so because they have left files open, resulting in this error:\r\n\r\n<pre name=\"code\"
  class=\"brush: bash\">\r\n$ p4 user -d -f SOMEUSER\r\nUser SOMEUSER has file(s)
  open on 2 client(s) and can't be deleted.\r\n<&#47;pre>\r\n\r\nThe solutions posted
  online usually involve either deleting the clients, or 'masquerading' as the client
  host and reverting the files by hand. This is very tedious, so I wrote a python
  script to do it instead. It's a bit crude, but all it does is take usernames off
  the command line, and proceeds to revert all the files that user has open on the
  server.\r\n\r\n"
wordpress_id: 105
wordpress_url: http://robpetti.com/?p=105
date: '2012-01-23 15:34:23 -0700'
date_gmt: '2012-01-23 20:34:23 -0700'
categories:
- Perforce
tags: []
comments:
- id: 12
  author: Simon
  author_email: stimms@gmail.com
  author_url: ''
  date: '2012-01-23 16:25:48 -0700'
  date_gmt: '2012-01-23 21:25:48 -0700'
  content: That main method sure looks like it has more than 3 lines of code in it...
- id: 14
  author: Rob Petti
  author_email: rob.petti@gmail.com
  author_url: http://www.robpetti.com
  date: '2012-01-23 22:23:07 -0700'
  date_gmt: '2012-01-24 03:23:07 -0700'
  content: Hence the "crude" part!
---
<p>I often find myself in the situation where I need to delete the perforce account of a user who has left the company. Unfortunately I'm usually unable to do so because they have left files open, resulting in this error:</p>
<pre name="code" class="brush: bash">
$ p4 user -d -f SOMEUSER<br />
User SOMEUSER has file(s) open on 2 client(s) and can't be deleted.<br />
<&#47;pre></p>
<p>The solutions posted online usually involve either deleting the clients, or 'masquerading' as the client host and reverting the files by hand. This is very tedious, so I wrote a python script to do it instead. It's a bit crude, but all it does is take usernames off the command line, and proceeds to revert all the files that user has open on the server.</p>
<p><a id="more"></a><a id="more-105"></a></p>
<pre name="code" class="brush: python">
#!&#47;usr&#47;bin&#47;python</p>
<p>import marshal<br />
import subprocess, shlex<br />
import re<br />
import os<br />
import sys</p>
<p>def getPerforceResponse(command):<br />
	lst = []<br />
	args = shlex.split(command)<br />
	p = subprocess.Popen(args, stdout=subprocess.PIPE)<br />
	try:<br />
		while 1:<br />
			dictionary = marshal.load(p.stdout)<br />
			lst.append(dictionary)<br />
	except EOFError:<br />
		pass<br />
	return lst</p>
<p>def getOpenedFiles():<br />
	return getPerforceResponse("p4 -G opened -a &#47;&#47;...")</p>
<p>def getOpenedFilesForUser(userID, opened):<br />
	openedByUser = []<br />
	for i in opened:<br />
		if i['user'] == userID:<br />
			openedByUser.append(i)<br />
	return openedByUser</p>
<p>def getClient(clientID):<br />
	return getPerforceResponse("p4 -G client -o \"" + clientID + "\"")[0]</p>
<p>def main():<br />
	print "Getting list of open files..."<br />
	opened = getOpenedFiles()<br />
	for user in sys.argv[1:]:<br />
		openedByUser = getOpenedFilesForUser(user, opened)<br />
		print "Found " + str(len(openedByUser)) + " opened files for " + user<br />
		print "reverting..."<br />
		for f in openedByUser:<br />
			print "Reverting " + f['depotFile'] + " on " + f['client']<br />
			client = getClient(f['client'])<br />
			host = client.get('Host', 'p4client')<br />
			response = getPerforceResponse("p4 -G -H " + host + " -c " + f['client'] + " -u " + user + " revert -k \"" + f['depotFile'] +"\"")<br />
			print response</p>
<p>main()<br />
<&#47;pre></p>
