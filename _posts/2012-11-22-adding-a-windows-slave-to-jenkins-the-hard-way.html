---
layout: post
status: publish
published: true
title: Adding a Windows slave to Jenkins the hard way
author:
  display_name: Rob Petti
  login: rpetti
  email: rob.petti@gmail.com
  url: http://www.robpetti.com
author_login: rpetti
author_email: rob.petti@gmail.com
author_url: http://www.robpetti.com
excerpt: "Jenkins makes adding slaves really easy. For unix machines, the preferred
  method is to use SSHD, which only requires that the master be able to contact the
  slave. On windows, however, you are stuck using a JNLP based solution, which requires
  that the slave be able to access master over the network.\r\n\r\nI got stuck in
  the awkward situation where I had to add a windows machine to our master, but the
  slave could not even ping it. This could be resolved by updating our routing tables
  on the slave side, but unfortunately that wasn't an option here. Instead I chose
  to try and start the slave using a Windows SSHD solution.\r\n"
wordpress_id: 121
wordpress_url: http://robpetti.com/?p=121
date: '2012-11-22 17:09:30 -0700'
date_gmt: '2012-11-22 22:09:30 -0700'
categories:
- Jenkins
tags: []
comments:
- id: 2900
  author: Joel
  author_email: babylonnian@gmail.com
  author_url: ''
  date: '2013-11-18 01:02:54 -0700'
  date_gmt: '2013-11-18 06:02:54 -0700'
  content: "Rob,\r\n\r\nye're a life saver.\r\n@unchecking the new console engine
    option.  + redirect stderr to text file.\r\nWorks like a charm.\r\n\r\nJoel."
- id: 2964
  author: roshan
  author_email: roshangrg@gmail.com
  author_url: ''
  date: '2013-12-03 00:24:31 -0700'
  date_gmt: '2013-12-03 05:24:31 -0700'
  content: You mentioned that you have switched to cygwin openssh, will your guide
    still work with cygwin ?
- id: 2966
  author: Rob Petti
  author_email: rob.petti@gmail.com
  author_url: http://www.robpetti.com
  date: '2013-12-03 00:35:09 -0700'
  date_gmt: '2013-12-03 05:35:09 -0700'
  content: No, but it should be considerably easier using cygwin. Just install it,
    set it up according to the online cygwin documentation, and add a new ssh slave
    to Jenkins. You don't need to follow the crazy steps here unless your builds can't
    deal with running in a cygwin environment for some reason.
---
<p>Jenkins makes adding slaves really easy. For unix machines, the preferred method is to use SSHD, which only requires that the master be able to contact the slave. On windows, however, you are stuck using a JNLP based solution, which requires that the slave be able to access master over the network.</p>
<p>I got stuck in the awkward situation where I had to add a windows machine to our master, but the slave could not even ping it. This could be resolved by updating our routing tables on the slave side, but unfortunately that wasn't an option here. Instead I chose to try and start the slave using a Windows SSHD solution.<br />
<a id="more"></a><a id="more-121"></a></p>
<p><b>Edit:<&#47;b> <em>I've found that the data throughput on FreeSSHD using the method I've outlined below leaves much to be desired. I've since switched over to installing cygwin and using it's sshd server instead. If you are using this pipe to send or archive files, I highly recommend using cygwin's sshd server instead, as it's several orders of magnitude faster. For example, I went from a 45 minute transfer, down to only 1 minute.<&#47;em></p>
<p>First things first, we need to install an ssh server onto the master. This was pretty easy, as I just used <a href="http:&#47;&#47;www.freesshd.com&#47;" title="FreeSSHD"><&#47;a>. Once installed, you need to make sure to stop the service, and run it by hand as administrator in order to change the settings. It'll show up in the toolbox on your system, so just right click it and click settings. From there you can set up your new user.</p>
<p>A few gotchas: You'll want to DISABLE "Use new console engine" on the SSH tab, seen below:<br />
<img src="http:&#47;&#47;robpetti.com&#47;wp-content&#47;uploads&#47;2012&#47;11&#47;freesshd-001.png" alt="Disable 'Use new console engine'" &#47;><br />
Also, when setting up pubkey authentication, you'll want to put the key into a file in the "Pubkey folder" that's defined in the Authentication tab of FreeSSHD. The file needs to have the exact same name as the new user you created. In my case, my user was called "releng" so I made a new text file called "releng" (no extension!) with the contents of my jenkins user's public key.</p>
<p>Test the connection from the master user by sshing into the slave as the jenkins user:<br />
<code><br />
jenkins@jenkins-master:~$ ssh releng@windows-slave-hostname<br />
<&#47;code></p>
<p>Once you've verified that passwordless authentication works, now it's time to set up the slave. Copy the slave.jar from your jenkins install (http:&#47;&#47;yourjenkinsurl&#47;jnlpJars&#47;slave.jar) onto the slave somewhere. In this example, I'll assume you placed it into C:\jenkins\.</p>
<p>Give it a shot again:</p>
<pre class="code">
jenkins@jenkins-master:~$ ssh releng@windows-slave-hostname java -jar C:&#47;jenkins&#47;slave.jar -text<br />
<&#47;pre></p>
<p>It should return something like:</p>
<pre class="code">
<===[JENKINS REMOTING CAPACITY]===>rO0ABXNyABpodWRzb24ucmVtb3RpbmcuQ2FwYWJpbGl0eQAAAAAAAAABAgABSgAEbWFza3hwAAAAAAAAAAY=<===[HUDSON TRANSMISSION BEGINS]===>rO0ABQ==<br />
<&#47;pre></p>
<p>That means it's working, but there's still more work to be done to get jenkins talking to it properly. First, set up a new Dumb slave in jenkins like you normally would, and select "Launch slave via execution of command on the Master". Unfortunately the built-in ssh functionality doesn't work because of the way FreeSSHD handles stdout and stderr.</p>
<p>Here's the launch command you need it to run:</p>
<pre class="code">
bash -c 'ssh releng@windows-slave cmd &#47;c "java -jar C:&#47;jenkins&#47;slave.jar -text 2>C:&#47;jenkins&#47;slave.junk.txt"'<br />
<&#47;pre></p>
<p>The redirect to slave junk is necessary because the slave.jar outputs informational messages to it's stderr. Normally these messages are not sent back to the master, but in this case FreeSSHD just pipes stderr into stdout, which would cause problems with the master as it parses the output. I'm not 100% sure if wrapping it in bash is necessary, but it seems to work fine.</p>
<p>Good luck!</p>
